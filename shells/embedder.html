<!DOCTYPE html>

<meta charset="utf8">
<title>...</title>

<h1 id="title">...</h1>
<iframe></iframe>
<div id="controls">
  <button title="prev" id="back" onclick="Dz.back()">
    <svg width="15px" height="15px" viewBox="0 0 50 50"><path d="M46.686,2.632L23.694,25.624l22.992,22.993H27.183L4.189,25.624 L27.183,2.632H46.686z"/></svg>
  </button>
  <button title="next" id="forward" onclick="Dz.forward()">
    <svg width="15px" height="15px" viewBox="0 0 50 50"><path d="M46.686,2.632L23.694,25.624l22.992,22.993H27.183L4.189,25.624 L27.183,2.632H46.686z"/></svg>
  </button>
  <p id="rightcontrols">
    <input onchange="Dz.setSlide(this.value)" size="2" id="slideidx" value="0" />/<span id="slidecount">...</span>
    <button title="Open in a new window" id="popup" onclick="Dz.popup()">
      <svg width="15px" height="15px" viewBox="0 0 50 50"><path d="M10,0L10,40L50,40L50,0z M0,5L5,5L5,45L45,45L45,50L0,50Z"/></svg>
    </button>
  </p>
</div>

<style>
  html { height: 100%;}
  body {
    margin: 0;
    background-color: black;
    height: 100%;
    display: -moz-box;
    display: -webkit-box;
    display: box;
    -moz-box-orient: vertical;
    -webkit-box-orient: vertical;
    box-orient: vertical;
    width: 100%;
  }
  iframe {
    -moz-box-flex : 1;
    -webkit-box-flex : 1;
    box-flex : 1;
    background-color: white;
    border: none;
    width: 100%;
    display: block;
    /* For IE: */
    height: 80%;
  }

  #title {
    font-weight: normal;
    font-family: monospace;
    margin: 0px;
    font-size: 19px;
    text-align: left;
  }
  #title, #controls {
    color: white;
    padding: 5px;
    position: relative;
  }
  #controls {
    font-family: monospace;
    font-size: 12px;
    text-align: center;
  }
  #controls path { fill: black; }
  #controls button[disabled] path {fill: #666;}
  #forward {-moz-transform: scaleX(-1);-webkit-transform: scaleX(-1);-o-transform: scaleX(-1);-ms-transform: scaleX(-1);transform: scaleX(-1);}
  button {
    background-color: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
  }
  #controls button[disabled] img { opacity: 0.4; }
  #slideidx {
    border: none;
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
    text-align: center;
  }
  #rightcontrols * { vertical-align: middle; }
  #rightcontrols {
    position: absolute;
    top: -5px;
    right: 10px;
  }
</style>

<script>
  var Dz = {
    view: null,
    url: null,
    idx: 1,
    count: null
  };
  
  Dz.init = function() {
    this.doCompatibilityChecks();
    this.loadIframe();
  }
  
  /**
   * Testing method for inline svg support
   * 
   * @return boolean
   */
  Dz.hasInlineSvg = function() {
    var div = document.createElement('div');
    div.innerHTML = '<svg/>';
    return (div.firstChild && div.firstChild.namespaceURI) == 'http://www.w3.org/2000/svg';
  }
  
  /**
   * Compatibility check(s) method which supports following functionalities:
   * - fallback for browsers that don't support inline svg
   */
  Dz.doCompatibilityChecks = function() {
    
    if (!this.hasInlineSvg()) {
      //Opera doesn't work with the NodeList forEach prototype, so we fallback to the Array version
      var svgElms = $$('svg');
      Array.prototype.forEach.call(svgElms, function(aNode, aIndex, aNodeList) {
          // let's work on a temp Node, thus be friendly to the current DOM
          var tmpNode = aNode.cloneNode(true);
          var xmlns = tmpNode.getAttribute('xmlns');
          if (!xmlns) { //we need a namespace if not set
              tmpNode.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          }
          
          var elmTxt = (new XMLSerializer()).serializeToString(tmpNode);
          var escapedHtmlElement = window.btoa(elmTxt);
          var replacement = document.createElement("img");
          replacement.alt = "";
          replacement.src = "data:image/svg+xml;base64,"+escapedHtmlElement+"";
          var w = tmpNode.getAttribute('width');
          if (w) {
              replacement.width = parseInt(w);
          }
          var h = tmpNode.getAttribute('height');
          if (h) {
              replacement.height = parseInt(h);
          }
          // replace the current svg Node
          aNode.parentNode.replaceChild(replacement, aNode);
          // cleanup our leftovers (and free up some memory)
          tmpNode = replacement = escapedHtmlElement = null;
      });
      svgElms = null;
    }
  }
  
  Dz.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      this.toggleContent();
    }
  }
  
  Dz.onmessage = function(aEvent) {
    if (aEvent.source === this.view) {
      var args = JSON.parse(aEvent.data);
      if (args.method === "newslide") {
        this.idx = ~~args.idx;
        $("#slideidx").value = this.idx;
        $("#back").disabled = this.idx == 1;
        $("#forward").disabled = this.idx == this.count;
      }
      if (args.method === "registered") {
        this.count = args.count;
        $("#slidecount").innerHTML = this.count;
        $("#title").innerHTML = args.title;
        document.title = args.title;
      }
    }
  }
  
  /* Get url from hash or prompt and store it */
  Dz.getUrl = function() {
    var u = window.location.hash.split("#")[1];
    if (!u) {
      u = window.prompt("What is the URL of the slides?");
      if (u) {
        window.location.hash = u.split("#")[0];
        return u;
      }
      u = "<style>body{background-color:white;color:black}</style>";
      u += "<strong>ERROR:</strong> No URL specified.<br>";
      u += "Try<em>: " + document.location + "#yourslides.html</em>";
      u = "data:text/html," + encodeURIComponent(u);
    }
    return u;
  }
  
  Dz.loadIframe = function() {
    var iframe = $("iframe");
    iframe.src = this.url = this.getUrl();
    iframe.onload = function() {
      Dz.view = this.contentWindow;
      Dz.view.postMessage("register", "*");
    }
  }
  
  Dz.toggleContent = function() {
    this.view.postMessage("toggleContent", "*");
  }
  
  Dz.onhashchange = function() {
    this.loadIframe();
  }
  
  Dz.back = function() {
    this.view.postMessage("back", "*");
  }

  Dz.forward = function() {
    this.view.postMessage("forward", "*");
  }

  Dz.setSlide = function(aIdx) {
    this.view.postMessage("setSlide(" + aIdx + ")", "*");
  }

  Dz.popup = function() {
    window.open(this.url + "#" + this.idx, '', 'width=800,height=600,personalbar=0,toolbar=0,scrollbars=1,resizable=1');
  }
  
</script>


<script> // Helpers
  if (!Function.prototype.bind) {
    Function.prototype.bind = function (oThis) {

      // closest thing possible to the ECMAScript 5 internal IsCallable
      // function 
      if (typeof this !== "function")
      throw new TypeError(
        "Function.prototype.bind - what is trying to be fBound is not callable"
      );

      var aArgs = Array.prototype.slice.call(arguments, 1),
          fToBind = this,
          fNOP = function () {},
          fBound = function () {
            return fToBind.apply( this instanceof fNOP ? this : oThis || window,
                   aArgs.concat(Array.prototype.slice.call(arguments)));
          };

      fNOP.prototype = this.prototype;
      fBound.prototype = new fNOP();

      return fBound;
    };
  }
  
  // moved the eventlisteners here, so binding also works in Opera
  window.onload = Dz.init.bind(Dz);
  window.onkeydown = Dz.onkeydown.bind(Dz);
  window.onhashchange = Dz.loadIframe.bind(Dz);
  window.onmessage = Dz.onmessage.bind(Dz);

  var $ = (HTMLElement.prototype.$ = function(aQuery) {
    return this.querySelector(aQuery);
  }).bind(document);
  
  var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
    return this.querySelectorAll(aQuery);
  }).bind(document);

</script>
